<!DOCTYPE html>
<html lang="en" class="dark"> <!-- Added dark mode preference -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Availability</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Optional: Configure Tailwind for dark mode based on class
        tailwind.config = {
            darkMode: 'class', // or 'media'
             theme: {
                 extend: {
                    fontFamily: {
                        // Optional: Ensure Inter font is used if Tailwind defaults change
                        sans: ['Inter', 'sans-serif'], 
                        mono: ['SFMono-Regular', 'Consolas', 'Liberation Mono', 'Menlo', 'monospace']
                    }
                 }
            }
        }
    </script>
     <style>
        /* Minimal styles for specific overrides if needed - keeping it clean */
        /* Style for absence list grouping */
        #existing-absences-list h4 { @apply mb-1 mt-4 border-b border-dashed border-gray-300 dark:border-gray-600 pb-1 text-lg font-semibold; }
        #existing-absences-list ul { @apply pl-0 mt-2 list-none; }
        #existing-absences-list li { @apply mb-3 border-b border-gray-200 dark:border-gray-700 pb-3; }
        /* Style for table */
        #totals-table th, #totals-table td { @apply p-2 border border-gray-300 dark:border-gray-600; }
        #totals-table th { @apply bg-gray-100 dark:bg-gray-700 font-semibold; }
        /* Style to hide filtered-out list items */
         .filtered-hide { display: none !important; } 
         /* Ensure filter input has some bottom margin */
         .filter-input { @apply mb-3; }
     </style>
</head>
<body class="bg-gray-200 dark:bg-gray-900 text-gray-900 dark:text-gray-100 font-sans leading-relaxed">

    <div class="max-w-4xl mx-auto p-4 md:p-6 lg:p-8"> <!-- Main content container -->

        <img src="logo.png" alt="Logo" class="w-40 h-auto mb-4 mx-auto sm:mx-0"> <!-- Centered on small screens -->
        <h1 class="text-3xl font-bold border-b border-gray-300 dark:border-gray-700 pb-3 mb-6 text-center sm:text-left">Teacher Availability</h1>

        <!-- Available Now Container -->
        <div class="bg-white dark:bg-gray-800 shadow-md rounded-lg p-6 mb-6">
            <h2 class="text-2xl font-semibold border-b border-gray-300 dark:border-gray-700 pb-2 mb-4">Available Right Now</h2>
            <div id="status-now" class="italic text-sm text-gray-600 dark:text-gray-400 mb-1">Loading schedule...</div>
            <span id="last-updated" class="text-xs text-gray-500 dark:text-gray-400 block mb-4"></span> 
             <!-- Filter Input for Available Now -->
            <input type="text" id="filter-now" placeholder="Filter by name..." class="filter-input block w-full sm:w-1/2 rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm bg-white dark:bg-gray-700 p-2">
            <div id="results-now" class="mt-4"><ul id="teachers-now" class="flex flex-wrap gap-2 list-none p-0"></ul></div>
        </div>

        <!-- Check Availability Container -->
        <div class="bg-white dark:bg-gray-800 shadow-md rounded-lg p-6 mb-6">
            <h2 class="text-2xl font-semibold border-b border-gray-300 dark:border-gray-700 pb-2 mb-4">Check Availability for a Time Range</h2>
            <div class="mb-4">
                <label for="date-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Date:</label>
                <input type="date" id="date-input" class="block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm bg-white dark:bg-gray-700 p-2">
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="time-from-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Time (From):</label>
                    <input type="time" id="time-from-input" class="block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm bg-white dark:bg-gray-700 p-2">
                </div>
                <div>
                    <label for="time-to-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Time (To):</label>
                    <input type="time" id="time-to-input" class="block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm bg-white dark:bg-gray-700 p-2">
                </div>
            </div>
            <button id="check-button" class="py-2 px-4 bg-green-600 text-white rounded-md font-semibold shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 dark:focus:ring-offset-gray-800">Check Availability</button>
            <div id="status-custom" class="italic text-sm text-gray-600 dark:text-gray-400 mt-4" style="display:none;"></div>
             <!-- Filter Input for Custom Range -->
            <input type="text" id="filter-custom" placeholder="Filter by name..." class="filter-input block w-full sm:w-1/2 rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm bg-white dark:bg-gray-700 p-2 mt-4">
            <div id="results-custom" class="mt-4"><ul id="teachers-custom" class="flex flex-wrap gap-2 list-none p-0"></ul></div>
        </div>

        <!-- Log Staff Absence Container -->
        <div class="bg-white dark:bg-gray-800 shadow-md rounded-lg p-6 mb-6">
            <h2 class="text-2xl font-semibold border-b border-gray-300 dark:border-gray-700 pb-2 mb-4">Log Staff Absence (Training, Meetings, etc.)</h2>
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Log a time range when a staff member is unavailable. This will remove them from the availability lists for that specific time.</p>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="absence-staff-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Staff Member:</label>
                    <select id="absence-staff-select" class="block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm bg-white dark:bg-gray-700 p-2">
                        <option value="">-- Select Staff --</option>
                    </select>
                </div>
                <div>
                    <label for="absence-date-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Date of Absence:</label>
                    <input type="date" id="absence-date-input" class="block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm bg-white dark:bg-gray-700 p-2">
                </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="absence-time-from-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Time (From):</label>
                    <input type="time" id="absence-time-from-input" class="block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm bg-white dark:bg-gray-700 p-2">
                </div>
                <div>
                    <label for="absence-time-to-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Time (To):</label>
                    <input type="time" id="absence-time-to-input" class="block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm bg-white dark:bg-gray-700 p-2">
                </div>
            </div>
            <button id="save-absence-button" class="py-2 px-4 bg-green-600 text-white rounded-md font-semibold shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 dark:focus:ring-offset-gray-800">Save Absence Entry</button>
            <div id="absence-save-status" class="italic text-sm text-gray-600 dark:text-gray-400 mt-3" style="display:none;"></div>
            
            <!-- Existing Absences -->
             <!-- Filter Input for Absences -->
            <input type="text" id="filter-absences" placeholder="Filter by name..." class="filter-input block w-full sm:w-1/2 rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm bg-white dark:bg-gray-700 p-2 mt-6">
            <h3 class="text-xl font-semibold mt-2 border-t border-gray-300 dark:border-gray-700 pt-4 mb-2">Existing Absences for Selected Day</h3>
            <div id="existing-absences-list" class="text-sm">
                <p class="status italic text-gray-600 dark:text-gray-400">Select a date to see existing entries.</p>
            </div>

            <!-- Absence Import/Export Buttons -->
            <div class="flex gap-4 flex-wrap mt-6">
                 <button id="export-absences-button" class="py-2 px-4 bg-purple-600 text-white rounded-md font-semibold shadow-sm hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 dark:focus:ring-offset-gray-800">Export Absences CSV</button>
                 <button id="import-absences-button" class="py-2 px-4 bg-white dark:bg-gray-200 text-gray-700 dark:text-gray-800 border border-gray-300 dark:border-gray-500 rounded-md font-semibold shadow-sm hover:bg-gray-50 dark:hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 dark:focus:ring-offset-gray-800">Import Absences CSV</button>
                 <input type="file" id="absence-csv-file-input" accept=".csv" class="hidden">
            </div>
             <div id="absence-import-status" class="italic text-sm text-gray-600 dark:text-gray-400 mt-3" style="display:none;"></div>
        </div>

        <!-- Extra Minutes Tracker Container -->
        <div class="bg-white dark:bg-gray-800 shadow-md rounded-lg p-6 mb-6">
            <h2 class="text-2xl font-semibold border-b border-gray-300 dark:border-gray-700 pb-2 mb-4">Extra Minutes Tracker</h2>
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Record extra minutes worked by staff. This data is saved in your browser.</p>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="staff-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Staff Member:</label>
                    <select id="staff-select" class="block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm bg-white dark:bg-gray-700 p-2">
                        <option value="">-- Select Staff --</option>
                    </select>
                </div>
                <div>
                    <label for="date-entry-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Date Worked:</label>
                    <input type="date" id="date-entry-input" class="block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm bg-white dark:bg-gray-700 p-2">
                </div>
            </div>
            <div class="mb-4">
                <label for="minutes-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Add Extra Minutes:</label>
                <input type="number" id="minutes-input" placeholder="e.g., 60" class="block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm bg-white dark:bg-gray-700 p-2">
            </div>
            <button id="save-minutes-button" class="py-2 px-4 bg-green-600 text-white rounded-md font-semibold shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 dark:focus:ring-offset-gray-800">Save Minutes</button>
            <div id="save-status" class="italic text-sm text-gray-600 dark:text-gray-400 mt-3" style="display:none;"></div>
        </div>

        <!-- Extra Minutes Totals Container -->
        <div class="bg-white dark:bg-gray-800 shadow-md rounded-lg p-6 mb-6">
            <h2 class="text-2xl font-semibold border-b border-gray-300 dark:border-gray-700 pb-2 mb-4">Extra Minutes Totals</h2>
            <div class="mb-4 max-w-xs"> <!-- Limit width of year input -->
                <label for="year-display" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Select Year:</label>
                <input type="number" id="year-display" value="2025" class="block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm bg-white dark:bg-gray-700 p-2">
            </div>
            <!-- Month Buttons - dynamically populated -->
            <div class="flex flex-wrap gap-2 mb-4" id="month-buttons"></div> 
            
            <!-- Totals Display Area - Will be replaced by table -->
            <div id="totals-display" class="bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-md p-4 min-h-[80px] overflow-x-auto"> 
                <p class="italic text-sm text-gray-600 dark:text-gray-400">Select a month to see totals.</p>
            </div>
            
            <!-- Minutes Import/Export/Clear Buttons -->
            <div class="flex flex-wrap gap-4 mt-6">
                <button id="export-backup-button" class="py-2 px-4 bg-purple-600 text-white rounded-md font-semibold shadow-sm hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 dark:focus:ring-offset-gray-800">Export CSV (Min)</button> 
                <button id="export-summary-button" class="py-2 px-4 bg-blue-600 text-white rounded-md font-semibold shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-offset-gray-800">Summary CSV (Min)</button>    
                <button id="import-csv-button" class="py-2 px-4 bg-white dark:bg-gray-200 text-gray-700 dark:text-gray-800 border border-gray-300 dark:border-gray-500 rounded-md font-semibold shadow-sm hover:bg-gray-50 dark:hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 dark:focus:ring-offset-gray-800">Import CSV (Min)</button>     
                <input type="file" id="csv-file-input" accept=".csv" class="hidden">
                <button id="clear-data-button" class="py-2 px-4 bg-red-600 text-white rounded-md font-semibold shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 dark:focus:ring-offset-gray-800">Clear All Saved Data</button>
            </div>
            <div id="import-status" class="italic text-sm text-gray-600 dark:text-gray-400 mt-3" style="display:none;"></div>
        </div>

    </div> <!-- End Main content container -->

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM fully loaded and parsed."); // Log DOM readiness

            // --- Global Variables ---
            let lessons = [];
            let allTeachers = new Set();
            let columnMap = {};
            let activeMonthButton = null;
            let refreshIntervalId = null; 

            // --- CONFIGURATION ---
            const dayMap = ["Sun", "Mon", "Tue", "Wed", "Thur", "Fri", "Sat"];
            const ARBETSTID_SUBJECT = "arbetstid";
            const ON_CALL_SUBJECT = "on call substitution";
            const REFRESH_INTERVAL_MS = 60000; 
            const MINUTES_STORAGE_KEY = 'teacherMinutesData'; 
            const ABSENCE_STORAGE_KEY = 'teacherAbsenceData';
            const EXCLUDE_TEACHER_LIST = ["BaSh", "AnHo", "DaWr", "AniFac", "RahHan", "ChBe", "FaCa", "SeCa", "AlCh", "LaCo", "VikCos", "RoDi", "KrEr", "RaHa", "JeHe", "DiHe", "GaHe", "HeKa", "JoLe", "TiLe", "WiLi", "ChLi", "HaLu", "KaMa", "ViMe", "MaMe", "HiOj", "LePa", "AsRo", "RaSc", "TaSc", "JeSe", "AnVa", "MarMen", "JonLeh"];
            const EXCLUDE_TEACHERS_SET = new Set(EXCLUDE_TEACHER_LIST);
            // ---------------------

            // --- Get DOM Elements ---
            const statusNow = document.getElementById('status-now');
            const teachersNowList = document.getElementById('teachers-now');
            const lastUpdatedSpan = document.getElementById('last-updated');
            const statusCustom = document.getElementById('status-custom');
            const teachersCustomList = document.getElementById('teachers-custom');
            const checkButton = document.getElementById('check-button');
            const dateInput = document.getElementById('date-input');
            const timeFromInput = document.getElementById('time-from-input');
            const timeToInput = document.getElementById('time-to-input');
            const staffSelect = document.getElementById('staff-select');
            const dateEntryInput = document.getElementById('date-entry-input');
            const minutesInput = document.getElementById('minutes-input');
            const saveMinutesButton = document.getElementById('save-minutes-button');
            const saveStatus = document.getElementById('save-status');
            const yearDisplay = document.getElementById('year-display');
            const monthButtonsContainer = document.getElementById('month-buttons');
            const totalsDisplay = document.getElementById('totals-display');
            const exportSummaryButton = document.getElementById('export-summary-button');
            const exportBackupButton = document.getElementById('export-backup-button');
            const clearDataButton = document.getElementById('clear-data-button');
            const importCsvButton = document.getElementById('import-csv-button');
            const csvFileInput = document.getElementById('csv-file-input');
            const importStatus = document.getElementById('import-status');
            const absenceStaffSelect = document.getElementById('absence-staff-select');
            const absenceDateInput = document.getElementById('absence-date-input');
            const absenceTimeFromInput = document.getElementById('absence-time-from-input');
            const absenceTimeToInput = document.getElementById('absence-time-to-input');
            const saveAbsenceButton = document.getElementById('save-absence-button');
            const absenceSaveStatus = document.getElementById('absence-save-status');
            const existingAbsencesList = document.getElementById('existing-absences-list');
            const exportAbsencesButton = document.getElementById('export-absences-button');
            const importAbsencesButton = document.getElementById('import-absences-button');
            const absenceCsvFileInput = document.getElementById('absence-csv-file-input');
            const absenceImportStatus = document.getElementById('absence-import-status');
            // Filter Inputs
            const filterNowInput = document.getElementById('filter-now');
            const filterCustomInput = document.getElementById('filter-custom');
            const filterAbsencesInput = document.getElementById('filter-absences');

            // --- Initial Checks ---
             if (!statusNow || !lastUpdatedSpan || !monthButtonsContainer || !staffSelect || !absenceStaffSelect || !exportAbsencesButton || !importAbsencesButton || !absenceCsvFileInput || !absenceImportStatus || !filterNowInput || !filterCustomInput || !filterAbsencesInput ) { 
                 console.error("Critical DOM element missing! Cannot proceed.", { /* ... logs ... */ });
                 if (statusNow) { statusNow.textContent = "Error: Page structure broken."; statusNow.classList.add('!text-red-600', '!dark:text-red-400', '!font-semibold'); } 
                 return; 
             }
             console.log("All critical DOM elements found.");

            // --- Utility Functions ---
            function getIsoWeekAndYear(d) { /* ... unchanged ... */ }
            function timeToMinutes(timeStr) { /* ... unchanged ... */ }
            function minutesToHHMM(totalMinutes) { /* ... unchanged ... */ }
            function parseRealWeeks(weekString) { /* ... unchanged ... */ }
            function parseTeachers(teacherString) { /* ... unchanged ... */ }
            function parseCsvLine(line) { /* ... unchanged ... */ }
            function dateToYYYYMMDD(dateObj) { /* ... unchanged ... */ }

            // --- Local Storage Functions ---
            function getSavedMinutesData() { /* ... unchanged ... */ }
            function saveMinutesData(data) { /* ... unchanged ... */ }
            function getSavedAbsenceData() { /* ... unchanged ... */ }
            function saveAbsenceData(data) { /* ... unchanged ... */ }

            // --- Status Update Functions ---
            function showSaveStatus(message, isError = false) { /* ... unchanged ... */ }
            function showImportStatus(message, isError = false) { /* ... unchanged ... */ }
            function showAbsenceSaveStatus(message, isError = false) { /* ... unchanged ... */ }
            function showAbsenceImportStatus(message, isError = false) { /* ... unchanged ... */ }
            
            // --- Availability Logic ---
            function getAvailabilityAtTime(dateTime) { /* ... unchanged ... */ }
            function getAvailabilityForRange(checkDate, checkStartMinutes, checkEndMinutes) { /* ... unchanged ... */ }
            function isTeacherAbsent(teacher, checkDate, checkTimeInMinutes) { /* ... unchanged ... */ }

            // --- UI Update Functions ---
            function displayResults(availableTeachers, onCallTimesMap, listElement, statusElement, checkDate) { /* ... unchanged ... */ }
            function displayExistingAbsences(dateKey) { /* ... unchanged ... */ }
            function populateStaffDropdown() { /* ... unchanged ... */ }
            function displayMonthlyTotals(year, monthIndex) { /* ... unchanged ... */ }
            function setupMonthButtons() { /* ... unchanged ... */ }
            function refreshAvailableNow() { /* ... unchanged ... */ }
            function refreshAbsenceList() { /* ... unchanged ... */ }
            function applyFilter(inputId, listContainerId, itemSelectorType) { /* ... unchanged ... */ }

            // --- Initialization ---
             async function loadData() { /* ... unchanged ... */ }


            // --- Event Listeners --- 
            // *** ADDED SAFETY CHECK to checkButton listener ***
            checkButton.addEventListener('click', () => {
                console.log("Check Availability button clicked."); // DEBUG
                try {
                    const date = dateInput.valueAsDate;
                    const timeFrom = timeFromInput.value;
                    const timeTo = timeToInput.value;

                    if (!date || !timeFrom || !timeTo) {
                         console.log("Check button validation failed: Missing date/time."); // DEBUG
                        statusCustom.textContent = 'Please select a date and a time range.';
                        statusCustom.style.display = 'block';
                        statusCustom.className = 'status mt-4 italic text-sm text-red-600 dark:text-red-400 font-semibold'; // Tailwind error
                        teachersCustomList.innerHTML = '';
                        return;
                    }

                    const startMinutes = timeToMinutes(timeFrom);
                    const endMinutes = timeToMinutes(timeTo);

                    if (startMinutes >= endMinutes) {
                        console.log("Check button validation failed: Start time >= End time."); // DEBUG
                        statusCustom.textContent = 'Invalid time: "From" time must be before "To" time.';
                        statusCustom.style.display = 'block';
                         statusCustom.className = 'status mt-4 italic text-sm text-red-600 dark:text-red-400 font-semibold'; // Tailwind error
                        teachersCustomList.innerHTML = '';
                        return;
                    }
                    
                    statusCustom.textContent = `Checking for: ${date.toDateString()} from ${timeFrom} to ${timeTo}...`;
                    statusCustom.style.display = 'block';
                    statusCustom.className = 'status mt-4 italic text-sm text-gray-600 dark:text-gray-400'; // Reset to default Tailwind
                    console.log(`Calling getAvailabilityForRange with date: ${date}, start: ${startMinutes}, end: ${endMinutes}`); // DEBUG

                    const availability = getAvailabilityForRange(date, startMinutes, endMinutes);
                    console.log("getAvailabilityForRange returned:", availability); // DEBUG

                    // *** ADDED SAFETY CHECK ***
                    if (availability && typeof availability === 'object' && availability.hasOwnProperty('available') && availability.hasOwnProperty('onCallTimes')) {
                        displayResults(availability.available, availability.onCallTimes, teachersCustomList, statusCustom, date); 
                        console.log("displayResults called for custom list."); // DEBUG
                    } else {
                        // Log an error if availability is not the expected object
                        console.error("ERROR: getAvailabilityForRange did not return the expected object. Returned:", availability);
                        statusCustom.textContent = `Internal error: Failed to get availability data structure. Check console.`;
                        statusCustom.style.display = 'block';
                        statusCustom.className = 'status mt-4 italic text-sm text-red-600 dark:text-red-400 font-semibold'; 
                        teachersCustomList.innerHTML = ''; // Clear list on error
                    }
                    // *** END ADDED SAFETY CHECK ***

                } catch (e) {
                    console.error("Error in checkButton click:", e);
                    statusCustom.textContent = `An error occurred: ${e.message}`;
                    statusCustom.style.display = 'block';
                    statusCustom.className = 'status mt-4 italic text-sm text-red-600 dark:text-red-400 font-semibold'; // Tailwind error
                }
            });
            saveMinutesButton.addEventListener('click', () => { /* ... unchanged ... */ });
            exportSummaryButton.addEventListener('click', () => { /* ... unchanged ... */ });
            exportBackupButton.addEventListener('click', () => { /* ... unchanged ... */ });
            clearDataButton.addEventListener('click', () => { /* ... unchanged ... */ });
            yearDisplay.addEventListener('change', () => { /* ... unchanged ... */ });
            importCsvButton.addEventListener('click', () => { csvFileInput.value = null; csvFileInput.click(); });
            csvFileInput.addEventListener('change', (event) => { /* ... unchanged ... */ });
            // Absence Listeners
            saveAbsenceButton.addEventListener('click', () => { /* ... unchanged ... */ });
            absenceDateInput.addEventListener('change', refreshAbsenceList);
            existingAbsencesList.addEventListener('click', (e) => { /* ... unchanged ... */ });
            exportAbsencesButton.addEventListener('click', () => { /* ... unchanged ... */ });
            importAbsencesButton.addEventListener('click', () => { absenceCsvFileInput.value = null; absenceCsvFileInput.click(); });
            absenceCsvFileInput.addEventListener('change', (event) => { /* ... unchanged ... */ });

            // *** Filter Event Listeners ***
            filterNowInput.addEventListener('input', () => applyFilter('filter-now', 'teachers-now', 'li'));
            filterCustomInput.addEventListener('input', () => applyFilter('filter-custom', 'teachers-custom', 'li'));
            filterAbsencesInput.addEventListener('input', () => applyFilter('filter-absences', 'existing-absences-list', 'group'));

            // Start the application
            loadData();
        });
    </script>
</body>
</html>

