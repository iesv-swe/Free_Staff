<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Availability</title>
    <style>
        body { /* Styles remain largely the same */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            background-color: #f6f8fa;
            color: #24292e;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
        }
        .logo { width: 180px; height: auto; margin-bottom: 10px; }
        h1, h2 { border-bottom: 2px solid #eaecef; padding-bottom: 10px; }
        .container { background-color: #ffffff; border: 1px solid #d1d5da; border-radius: 6px; padding: 24px; margin-bottom: 20px; }
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-weight: 600; margin-bottom: 5px; }
        .input-group input, .input-group select { width: 95%; padding: 8px 12px; border: 1px solid #d1d5da; border-radius: 6px; background-color: #fff; }
        button { background-color: #2ea44f; color: #ffffff; font-weight: 600; padding: 10px 16px; border: 1px solid rgba(27, 31, 35, 0.15); border-radius: 6px; cursor: pointer; margin-top: 10px; }
        button:hover { background-color: #2c974b; }
        button.secondary { background-color: #f6f8fa; color: #24292e; }
        button.secondary:hover { background-color: #f3f4f6; }
        button.danger { background-color: #d73a49; border-color: rgba(27, 31, 35, 0.15); }
        button.danger:hover { background-color: #cb2431; }
        button.success { background-color: #2ea44f; color: #ffffff; }
        button.success:hover { background-color: #2c974b; }
        button.primary { background-color: #6f42c1; color: #ffffff; border-color: rgba(27, 31, 35, 0.15); }
        button.primary:hover { background-color: #5833a6; }
        .button-group { display: flex; justify-content: space-between; gap: 10px; flex-wrap: wrap; }
        .results { margin-top: 20px; }
        .status { font-style: italic; color: #586069; }
        .status.error { color: #d73a49; font-weight: 600; }
        .status.success { color: #2ea44f; font-weight: 600; }
        .teacher-list { display: flex; flex-wrap: wrap; gap: 8px; list-style: none; padding: 0; }
        .teacher-list li { background-color: #f6f8fa; border: 1px solid #d1d5da; border-radius: 10px; padding: 5px 12px; font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace; }
        .teacher-list li.on-call { background-color: #2ea44f; color: #ffffff; border-color: #2c974b; font-weight: 600; }
        .teacher-list li.minutes-danger { background-color: #d73a49; color: #ffffff; border: 1px solid #cb2431; font-weight: 600; }
        .teacher-list li.minutes-warn { background-color: #ffc107; border: 1px solid #e0a800; color: #212529; }
        .month-buttons { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 15px; }
        .month-buttons button { flex-grow: 1; margin-top: 0; padding: 5px 8px; }
        .month-buttons button.active { background-color: #0366d6; color: #ffffff; border-color: #0366d6; font-weight: 600; }
        #totals-display { background-color: #f6f8fa; border: 1px solid #d1d5da; border-radius: 6px; padding: 15px; min-height: 50px; }
        #totals-display h3 { margin-top: 0; }
        #totals-display li { font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace; list-style: none; padding: 4px 8px; margin: 2px 0; border-radius: 4px; }
        #totals-display li.minutes-danger { background-color: #d73a49; color: #ffffff; border: 1px solid #cb2431; font-weight: 600; }
        #totals-display li.minutes-warn { background-color: #ffc107; border: 1px solid #e0a800; color: #212529; }
        #csv-file-input { display: none; }
    </style>
</head>
<body>

    <img src="logo.png" alt="Logo" class="logo">
    <h1>Teacher Availability</h1>

    <div class="container">
        <h2>Available Right Now</h2>
        <div id="status-now" class="status">Loading schedule...</div>
        <div id="results-now" class="results"><ul id="teachers-now" class="teacher-list"></ul></div>
    </div>
    <div class="container">
        <h2>Check Availability for a Time Range</h2>
        <div class="input-group"><label for="date-input">Date:</label><input type="date" id="date-input"></div>
        <div class="input-grid">
            <div class="input-group"><label for="time-from-input">Time (From):</label><input type="time" id="time-from-input"></div>
            <div class="input-group"><label for="time-to-input">Time (To):</label><input type="time" id="time-to-input"></div>
        </div>
        <button id="check-button">Check Availability</button>
        <div id="status-custom" class="status" style="display:none;"></div>
        <div id="results-custom" class="results"><ul id="teachers-custom" class="teacher-list"></ul></div>
    </div>

    <div class="container">
        <h2>Record Absence</h2>
        <p>Record meetings, training, or other absences not in the main schedule.</p>
        <div class="input-grid">
            <div class="input-group">
                <label for="absence-staff-select">Staff Member:</label>
                <select id="absence-staff-select"><option value="">-- Select Staff --</option></select>
            </div>
            <div class="input-group">
                <label for="absence-date-input">Date of Absence:</label>
                <input type="date" id="absence-date-input">
            </div>
        </div>
         <div class="input-grid">
            <div class="input-group">
                <label for="absence-start-input">Start Time:</label>
                <input type="time" id="absence-start-input">
            </div>
            <div class="input-group">
                <label for="absence-end-input">End Time:</label>
                <input type="time" id="absence-end-input">
            </div>
        </div>
        <div class="input-group">
            <label for="absence-reason-input">Reason (Optional):</label>
            <input type="text" id="absence-reason-input" placeholder="e.g., Training">
        </div>
        <button id="save-absence-button">Save Absence</button>
        <div id="absence-status" class="status" style="display:none; margin-top:10px;"></div>
        </div>

    <div class="container">
        <h2>Extra Minutes Tracker</h2>
        <p>Record extra minutes worked by staff. This data is saved in your browser.</p>
        <div class="input-grid">
            <div class="input-group"><label for="staff-select">Staff Member:</label><select id="staff-select"><option value="">-- Select Staff --</option></select></div>
            <div class="input-group"><label for="date-entry-input">Date Worked:</label><input type="date" id="date-entry-input"></div>
        </div>
        <div class="input-group"><label for="minutes-input">Add Extra Minutes:</label><input type="number" id="minutes-input" placeholder="e.g., 60"></div>
        <button id="save-minutes-button">Save Minutes</button>
        <div id="save-status" class="status" style="display:none; margin-top:10px;"></div>
    </div>

    <div class="container">
        <h2>Extra Minutes Totals</h2>
        <div class="input-group"><label for="year-display">Select Year:</label><input type="number" id="year-display" value="2025"></div>
        <div class="month-buttons" id="month-buttons"></div>
        <div id="totals-display"><p>Select a month to see totals.</p></div>
        <div class="button-group">
            <button id="export-backup-button" class="success">Export Backup CSV</button>
            <button id="export-summary-button" class="primary">Export Summary CSV</button>
            <button id="import-csv-button" class="secondary">Import Entries from CSV</button>
            <input type="file" id="csv-file-input" accept=".csv">
            <button id="clear-data-button" class="danger">Clear All Saved Data</button>
        </div>
        <div id="import-status" class="status" style="display:none; margin-top:10px;"></div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let lessons = [];
            let allTeachers = new Set();
            let columnMap = {};
            let activeMonthButton = null;
            
            const dayMap = ["Sun", "Mon", "Tue", "Wed", "Thur", "Fri", "Sat"];

            // --- CONFIGURATION ---
            const ARBETSTID_SUBJECT = "arbetstid";
            const ON_CALL_SUBJECT = "on call substitution";
            const EXCLUDE_TEACHER_LIST = ["BaSh", "AnHo", "DaWr", "AniFac", "RahHan", "ChBe", "FaCa", "SeCa", "AlCh", "LaCo", "VikCos", "RoDi", "KrEr", "RaHa", "JeHe", "DiHe", "GaHe", "HeKa", "JoLe", "TiLe", "WiLi", "ChLi", "HaLu", "KaMa", "ViMe", "MaMe", "HiOj", "LePa", "AsRo", "RaSc", "TaSc", "JeSe", "AnVa", "MarMen", "JonLeh"];
            const EXCLUDE_TEACHERS_SET = new Set(EXCLUDE_TEACHER_LIST);
            // ---------------------

            // --- Get DOM Elements ---
            const statusNow = document.getElementById('status-now');
            const teachersNowList = document.getElementById('teachers-now');
            const statusCustom = document.getElementById('status-custom');
            const teachersCustomList = document.getElementById('teachers-custom');
            const checkButton = document.getElementById('check-button');
            const dateInput = document.getElementById('date-input');
            const timeFromInput = document.getElementById('time-from-input');
            const timeToInput = document.getElementById('time-to-input');
            const staffSelect = document.getElementById('staff-select');
            const dateEntryInput = document.getElementById('date-entry-input');
            const minutesInput = document.getElementById('minutes-input');
            const saveMinutesButton = document.getElementById('save-minutes-button');
            const saveStatus = document.getElementById('save-status');
            const yearDisplay = document.getElementById('year-display');
            const monthButtonsContainer = document.getElementById('month-buttons');
            const totalsDisplay = document.getElementById('totals-display');
            const exportSummaryButton = document.getElementById('export-summary-button');
            const exportBackupButton = document.getElementById('export-backup-button');
            const clearDataButton = document.getElementById('clear-data-button');
            const importCsvButton = document.getElementById('import-csv-button');
            const csvFileInput = document.getElementById('csv-file-input');
            const importStatus = document.getElementById('import-status');
            // *** NEW: Absence elements ***
            const absenceStaffSelect = document.getElementById('absence-staff-select');
            const absenceDateInput = document.getElementById('absence-date-input');
            const absenceStartInput = document.getElementById('absence-start-input');
            const absenceEndInput = document.getElementById('absence-end-input');
            const absenceReasonInput = document.getElementById('absence-reason-input');
            const saveAbsenceButton = document.getElementById('save-absence-button');
            const absenceStatus = document.getElementById('absence-status');
            // *** END NEW ***


            // --- Helper Functions ---
            
            function getIsoWeekAndYear(d) { /* ... same ... */ }
            function timeToMinutes(timeStr) { /* ... same ... */ }
            function minutesToHHMM(totalMinutes) { /* ... same ... */ }
            function parseRealWeeks(weekString) { /* ... same ... */ }
            function parseTeachers(teacherString) { /* ... same ... */ }
            
            // --- Logic Function 1: Availability at a specific moment ---
            // *** UPDATED: Checks absences ***
            function getAvailabilityAtTime(dateTime) {
                const workingTeachers = new Set(); 
                const onCallTimesMap = new Map(); 
                const busyTeachers = new Set(); 
                const { week: checkWeekNum, year: checkWeekYear } = getIsoWeekAndYear(dateTime); 
                const checkDay = dayMap[dateTime.getDay()]; 
                const checkTimeInMinutes = (dateTime.getHours() * 60) + dateTime.getMinutes(); 
                
                // 1. Check Lessons.txt
                lessons.forEach(lesson => { /* ... same logic as before ... */ 
                    const lessonDay = lesson[columnMap['day']].trim(); const lessonWeeks = parseRealWeeks(lesson[columnMap['realweeks']]); const scheduleWeekNum = parseInt(lesson[columnMap['realweeks']], 10); if (lessonDay !== checkDay || !lessonWeeks.has(checkWeekNum)) return; const lessonStart = timeToMinutes(lesson[columnMap['starttime']]); const lessonLength = parseInt(lesson[columnMap['length']], 10); const lessonEnd = lessonStart + lessonLength; const subject = lesson[columnMap['subject']].trim().toLowerCase(); if (checkTimeInMinutes >= lessonStart && checkTimeInMinutes < lessonEnd) { const teachers = parseTeachers(lesson[columnMap['teacher']]); if (subject === ARBETSTID_SUBJECT) { teachers.forEach(t => workingTeachers.add(t)); } else if (subject === ON_CALL_SUBJECT) { teachers.forEach(t => { workingTeachers.add(t); if (!onCallTimesMap.has(t)) { onCallTimesMap.set(t, { start: lessonStart, end: lessonEnd }); } }); } else { teachers.forEach(t => busyTeachers.add(t)); } } 
                }); 
                
                let availableTeacherNames = [...workingTeachers].filter(teacher => !busyTeachers.has(teacher));

                // 2. Check saved absences
                const absences = getSavedAbsences();
                const checkDateKey = dateTime.toISOString().split('T')[0]; // "YYYY-MM-DD"
                const todaysAbsences = absences[checkDateKey] || {};

                availableTeacherNames = availableTeacherNames.filter(teacher => {
                    const staffAbsences = todaysAbsences[teacher];
                    if (!staffAbsences || staffAbsences.length === 0) {
                        return true; // No absence recorded for this teacher today
                    }
                    // Check if *any* absence overlaps with the check time
                    for (const absence of staffAbsences) {
                        if (checkTimeInMinutes >= absence.start && checkTimeInMinutes < absence.end) {
                            return false; // Teacher is absent now
                        }
                    }
                    return true; // No overlapping absence found
                });

                return { available: availableTeacherNames.sort(), onCallTimes: onCallTimesMap };
            }

            // --- Logic Function 2: Availability for a time range ---
            // *** UPDATED: Checks absences ***
            function getAvailabilityForRange(checkDate, checkStartMinutes, checkEndMinutes) {
                 let workingTeachers = new Set(); 
                 const onCallTimesMap = new Map(); 
                 const busyTeachers = new Set(); 
                 const { week: checkWeekNum, year: checkWeekYear } = getIsoWeekAndYear(checkDate); 
                 const checkDay = dayMap[checkDate.getDay()]; 

                 // 1. Check Lessons.txt
                 lessons.forEach(lesson => { /* ... same logic as before ... */ 
                    const lessonDay = lesson[columnMap['day']].trim(); const lessonWeeks = parseRealWeeks(lesson[columnMap['realweeks']]); const scheduleWeekNum = parseInt(lesson[columnMap['realweeks']], 10); if (lessonDay !== checkDay || !lessonWeeks.has(checkWeekNum)) return; const lessonStart = timeToMinutes(lesson[columnMap['starttime']]); const lessonLength = parseInt(lesson[columnMap['length']], 10); const lessonEnd = lessonStart + lessonLength; const subject = lesson[columnMap['subject']].trim().toLowerCase(); const teachers = parseTeachers(lesson[columnMap['teacher']]); const containsQuery = (lessonStart <= checkStartMinutes && lessonEnd >= checkEndMinutes); const overlapsQuery = (lessonStart < checkEndMinutes && lessonEnd > checkStartMinutes); if (subject === ARBETSTID_SUBJECT) { if (containsQuery) teachers.forEach(t => workingTeachers.add(t)); } else if (subject === ON_CALL_SUBJECT) { if (containsQuery) { teachers.forEach(t => { workingTeachers.add(t); if (!onCallTimesMap.has(t)) { onCallTimesMap.set(t, { start: lessonStart, end: lessonEnd }); } }); } } else if (overlapsQuery) { teachers.forEach(t => busyTeachers.add(t)); } 
                 }); 
                 
                 let availableTeacherNames = [...workingTeachers].filter(teacher => !busyTeachers.has(teacher));

                 // 2. Check saved absences
                 const absences = getSavedAbsences();
                 const checkDateKey = checkDate.toISOString().split('T')[0]; // "YYYY-MM-DD"
                 const todaysAbsences = absences[checkDateKey] || {};

                 availableTeacherNames = availableTeacherNames.filter(teacher => {
                     const staffAbsences = todaysAbsences[teacher];
                     if (!staffAbsences || staffAbsences.length === 0) {
                         return true; // No absence recorded
                     }
                     // Check if *any* absence overlaps with the query range
                     for (const absence of staffAbsences) {
                         // Overlap = absence starts before query ends AND absence ends after query starts
                         if (absence.start < checkEndMinutes && absence.end > checkStartMinutes) {
                             return false; // Teacher has an overlapping absence
                         }
                     }
                     return true; // No overlapping absence found
                 });

                 return { available: availableTeacherNames.sort(), onCallTimes: onCallTimesMap };
            }


            // --- Display Function (Availability) ---
            function displayResults(availableTeachers, onCallTimesMap, listElement, statusElement, checkDate) { /* ... same ... */ }
            
            // --- Extra Minutes Helper Functions ---
            function getSavedMinutesData() { /* ... same ... */ }
            function saveMinutesData(data) { /* ... same ... */ }
            
            // *** NEW: Absence Helper Functions ***
            // Structure: {"YYYY-MM-DD": {"Staff": [{start: min, end: min, reason: ""}, ... ]}}
             function getSavedAbsences() {
                try {
                    const data = localStorage.getItem('teacherAbsences');
                    const parsed = data ? JSON.parse(data) : {};
                    return typeof parsed === 'object' && parsed !== null ? parsed : {};
                } catch (e) {
                    console.error("Failed to parse absences data:", e);
                    return {};
                }
            }

            function saveAbsences(data) {
                try {
                    localStorage.setItem('teacherAbsences', JSON.stringify(data));
                } catch (e) {
                    console.error("Failed to save absences data:", e);
                }
            }
             function showAbsenceStatus(message, isError = false) {
                absenceStatus.textContent = message;
                absenceStatus.className = isError ? 'status error' : 'status success';
                absenceStatus.style.display = 'block';
                setTimeout(() => { absenceStatus.style.display = 'none'; }, 3000);
            }
            // *** END NEW ***


            // *** UPDATED: Populates all staff dropdowns ***
            function populateStaffDropdown() {
                const sortedTeachers = [...allTeachers].filter(teacher => !EXCLUDE_TEACHERS_SET.has(teacher)).sort(); 
                
                // Clear existing options (except placeholder)
                staffSelect.innerHTML = '<option value="">-- Select Staff --</option>'; 
                absenceStaffSelect.innerHTML = '<option value="">-- Select Staff --</option>'; 

                sortedTeachers.forEach(teacher => { 
                    const option = document.createElement('option'); 
                    option.value = teacher; 
                    option.textContent = teacher; 
                    staffSelect.appendChild(option.cloneNode(true)); // For minutes entry
                    absenceStaffSelect.appendChild(option.cloneNode(true)); // For absence entry
                });
            }

            function showSaveStatus(message, isError = false) { /* ... same ... */ }
            function showImportStatus(message, isError = false) { /* ... same ... */ }
            function displayMonthlyTotals(year, monthIndex) { /* ... same ... */ }
            function setupMonthButtons() { /* ... same ... */ }

            // --- Initialization ---
            async function loadData() {
                try {
                    // ... Fetching logic ...
                    const response = await fetch('Lessons.txt'); if (!response.ok) throw new Error(`Fetch failed.`); const text = await response.text(); const lines = text.split(/\r?\n/).filter(l => l.trim()); if (lines.length < 2) throw new Error('File empty/invalid.'); const header = lines[0].split('\t'); header.forEach((c, i) => { columnMap[c.trim()] = i; }); const requiredCols = ['subject', 'teacher', 'day', 'starttime', 'length', 'realweeks']; for (const col of requiredCols) { if (columnMap[col] === undefined) throw new Error(`Missing column: ${col}`); } lessons = lines.slice(1).map(l => l.split('\t')); lessons.forEach(l => { parseTeachers(l[columnMap['teacher']]).forEach(t => allTeachers.add(t)); });
                    
                    statusNow.textContent = `Schedule loaded. Checking for: ${new Date().toLocaleString()}`;
                    
                    const now = new Date();
                    const { available, onCallTimes } = getAvailabilityAtTime(now);
                    displayResults(available, onCallTimes, teachersNowList, statusNow, now);
                    
                    dateInput.valueAsDate = now;
                    timeFromInput.value = now.toTimeString().substring(0, 5);
                    const later = new Date(now.getTime() + 60 * 60 * 1000); 
                    timeToInput.value = later.toTimeString().substring(0, 5);

                    populateStaffDropdown(); // Populates both dropdowns now
                    setupMonthButtons(); 
                    dateEntryInput.valueAsDate = now; 
                    // *** NEW: Set default absence date ***
                    absenceDateInput.valueAsDate = now;
                    yearDisplay.value = now.getFullYear();

                    const currentMonthIndex = now.getMonth();
                    const currentMonthButton = monthButtonsContainer.querySelector(`button[data-month-index="${currentMonthIndex}"]`);
                    if (currentMonthButton) {
                        currentMonthButton.click(); 
                    }

                } catch (error) {
                    statusNow.textContent = `Error: ${error.message}`;
                    statusNow.classList.add('error');
                    console.error(error);
                }
            }

            // --- Event Listeners (Availability) ---
            checkButton.addEventListener('click', () => { /* ... same ... */ });

            // --- Event Listeners (Extra Minutes) ---
            saveMinutesButton.addEventListener('click', () => { /* ... same ... */ });
            exportSummaryButton.addEventListener('click', () => { /* ... same ... */ });
            exportBackupButton.addEventListener('click', () => { /* ... same ... */ });
            clearDataButton.addEventListener('click', () => { /* ... same ... */ });
            yearDisplay.addEventListener('change', () => { /* ... same ... */ });
            importCsvButton.addEventListener('click', () => { csvFileInput.click(); }); 
            csvFileInput.addEventListener('change', (event) => { /* ... same ... */ });

             // *** NEW: Event Listener for Save Absence ***
             saveAbsenceButton.addEventListener('click', () => {
                const staff = absenceStaffSelect.value;
                const date = absenceDateInput.value; // "YYYY-MM-DD"
                const startTime = absenceStartInput.value; // "HH:MM"
                const endTime = absenceEndInput.value; // "HH:MM"
                const reason = absenceReasonInput.value.trim();

                if (!staff) { showAbsenceStatus("Select staff.", true); return; }
                if (!date) { showAbsenceStatus("Select date.", true); return; }
                if (!startTime || !endTime) { showAbsenceStatus("Select start and end times.", true); return; }

                const startMinutes = timeToMinutes(startTime);
                const endMinutes = timeToMinutes(endTime);

                if (endMinutes <= startMinutes) {
                    showAbsenceStatus("End time must be after start time.", true); return;
                }

                const allAbsences = getSavedAbsences();

                // Ensure date entry exists
                if (!allAbsences[date]) {
                    allAbsences[date] = {};
                }
                // Ensure staff entry exists for that date
                 if (!allAbsences[date][staff]) {
                    allAbsences[date][staff] = [];
                }

                // Add the new absence record
                allAbsences[date][staff].push({
                    start: startMinutes,
                    end: endMinutes,
                    reason: reason 
                });

                // Optional: Sort absences by start time if multiple exist for one person/day
                allAbsences[date][staff].sort((a, b) => a.start - b.start);

                saveAbsences(allAbsences);

                showAbsenceStatus(`Saved absence for ${staff} on ${date} from ${startTime} to ${endTime}.`, false);

                // Clear inputs
                absenceStaffSelect.value = '';
                // absenceDateInput.valueAsDate = new Date(); // Or keep date?
                absenceStartInput.value = '';
                absenceEndInput.value = '';
                absenceReasonInput.value = '';
            });
             // *** END NEW ***
            
            // Start the application
            loadData();
        });
    </script>
</body>
</html>
