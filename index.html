<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Availability</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'], // Use Inter font
                    },
                }
            }
        }
    </script>
    <style>
        /* Small style block for minor adjustments if needed */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Style for absence list grouping */
        #existing-absences-list h4 { @apply text-lg font-semibold mt-4 mb-2 border-b border-dashed border-gray-300 pb-1; }
        #existing-absences-list ul { @apply list-none pl-0 mt-1; }
        #existing-absences-list li { @apply mb-3 pb-3 border-b border-gray-200 flex justify-between items-center; }
        #existing-absences-list li button { @apply mt-0 text-xs px-2 py-1; } 
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <img src="logo.png" alt="Logo" class="w-40 h-auto mb-4" onerror="this.style.display='none'"> <!-- Added onerror -->
        <h1 class="text-3xl font-bold text-gray-900 border-b-2 border-gray-200 pb-3 mb-6">Teacher Availability</h1>

        <!-- Available Now Section -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-2xl font-semibold mb-4 border-b border-gray-200 pb-2">Available Right Now</h2>
            <div id="status-now" class="text-gray-600 italic mb-4">Loading schedule...</div>
            <div id="results-now" class="results">
                <ul id="teachers-now" class="flex flex-wrap gap-2 list-none p-0"></ul>
            </div>
        </div>

        <!-- Check Availability Section -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-2xl font-semibold mb-4 border-b border-gray-200 pb-2">Check Availability for a Time Range</h2>
            <div class="mb-4">
                <label for="date-input" class="block font-medium mb-1">Date:</label>
                <input type="date" id="date-input" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="time-from-input" class="block font-medium mb-1">Time (From):</label>
                    <input type="time" id="time-from-input" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="time-to-input" class="block font-medium mb-1">Time (To):</label>
                    <input type="time" id="time-to-input" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
            <button id="check-button" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-md shadow-sm transition duration-150 ease-in-out">Check Availability</button>
            <div id="status-custom" class="text-gray-600 italic mt-4" style="display:none;"></div>
            <div id="results-custom" class="results mt-4">
                <ul id="teachers-custom" class="flex flex-wrap gap-2 list-none p-0"></ul>
            </div>
        </div>

        <!-- Log Absence Section -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-2xl font-semibold mb-4 border-b border-gray-200 pb-2">Log Staff Absence (Training, Meetings, etc.)</h2>
            <p class="text-gray-600 mb-4">Log a time range when a staff member is unavailable. This will remove them from the availability lists for that specific time.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="absence-staff-select" class="block font-medium mb-1">Staff Member:</label>
                    <select id="absence-staff-select" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="">-- Select Staff --</option>
                    </select>
                </div>
                <div>
                    <label for="absence-date-input" class="block font-medium mb-1">Date of Absence:</label>
                    <input type="date" id="absence-date-input" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="absence-time-from-input" class="block font-medium mb-1">Time (From):</label>
                    <input type="time" id="absence-time-from-input" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="absence-time-to-input" class="block font-medium mb-1">Time (To):</label>
                    <input type="time" id="absence-time-to-input" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
            <button id="save-absence-button" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-md shadow-sm transition duration-150 ease-in-out">Save Absence Entry</button>
            <div id="absence-save-status" class="status mt-3" style="display:none;"></div>
            
            <h3 class="text-xl font-semibold mt-6 border-t border-gray-200 pt-4 mb-2">Existing Absences for Selected Day</h3>
            <div id="existing-absences-list">
                <p class="status">Select a date to see existing entries.</p> 
            </div>

            <div class="absence-button-group mt-4">
                 <button id="export-absences-button" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-md shadow-sm transition duration-150 ease-in-out">Export Absences CSV</button>
                 <button id="import-absences-button" class="bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-2 px-4 border border-gray-300 rounded-md shadow-sm transition duration-150 ease-in-out">Import Absences CSV</button>
                 <input type="file" id="absence-csv-file-input" accept=".csv" class="hidden">
            </div>
             <div id="absence-import-status" class="status mt-3" style="display:none;"></div>
        </div>

        <!-- Extra Minutes Tracker Section -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-2xl font-semibold mb-4 border-b border-gray-200 pb-2">Extra Minutes Tracker</h2>
            <p class="text-gray-600 mb-4">Record extra minutes worked by staff. This data is saved in your browser.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="staff-select" class="block font-medium mb-1">Staff Member:</label>
                    <select id="staff-select" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="">-- Select Staff --</option>
                    </select>
                </div>
                <div>
                    <label for="date-entry-input" class="block font-medium mb-1">Date Worked:</label>
                    <input type="date" id="date-entry-input" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
            <div class="mb-4">
                <label for="minutes-input" class="block font-medium mb-1">Add Extra Minutes:</label>
                <input type="number" id="minutes-input" placeholder="e.g., 60" class="w-full md:w-1/2 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>
            <button id="save-minutes-button" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-md shadow-sm transition duration-150 ease-in-out">Save Minutes</button>
            <div id="save-status" class="status mt-3" style="display:none;"></div>
        </div>

        <!-- Extra Minutes Totals Section -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-2xl font-semibold mb-4 border-b border-gray-200 pb-2">Extra Minutes Totals</h2>
            <div class="mb-4">
                <label for="year-display" class="block font-medium mb-1">Select Year:</label>
                <input type="number" id="year-display" value="2025" class="w-full md:w-1/4 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div class="month-buttons mb-4 flex flex-wrap gap-1">
                 <!-- Month buttons will be generated here by JS -->
            </div>
            <div id="totals-display" class="bg-gray-50 border border-gray-200 rounded-md p-4 min-h-[6rem]">
                <p class="status">Select a month to see totals.</p>
            </div>
             <!-- Original Minutes Import/Export/Clear Buttons -->
            <div class="button-group mt-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-2">
                <button id="export-backup-button" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md shadow-sm transition duration-150 ease-in-out text-sm">Export Backup CSV (Minutes Only)</button> 
                <button id="export-summary-button" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-md shadow-sm transition duration-150 ease-in-out text-sm">Export Summary CSV (Minutes Only)</button>
                <button id="import-csv-button" class="bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-2 px-4 border border-gray-300 rounded-md shadow-sm transition duration-150 ease-in-out text-sm">Import Entries CSV (Minutes Only)</button>
                <input type="file" id="csv-file-input" accept=".csv" class="hidden">
                <button id="clear-data-button" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-md shadow-sm transition duration-150 ease-in-out text-sm col-span-1 sm:col-span-2 lg:col-span-1 lg:col-start-4">Clear All Saved Data</button>
            </div>
            <div id="import-status" class="status mt-3" style="display:none;"></div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM fully loaded and parsed."); // Log DOM readiness

            let lessons = [];
            let allTeachers = new Set();
            let columnMap = {};
            let activeMonthButton = null;

            const dayMap = ["Sun", "Mon", "Tue", "Wed", "Thur", "Fri", "Sat"];

            // --- CONFIGURATION ---
            const ARBETSTID_SUBJECT = "arbetstid";
            const ON_CALL_SUBJECT = "on call substitution";
            const EXCLUDE_TEACHER_LIST = ["BaSh", "AnHo", "DaWr", "AniFac", "RahHan", "ChBe", "FaCa", "SeCa", "AlCh", "LaCo", "VikCos", "RoDi", "KrEr", "RaHa", "JeHe", "DiHe", "GaHe", "HeKa", "JoLe", "TiLe", "WiLi", "ChLi", "HaLu", "KaMa", "ViMe", "MaMe", "HiOj", "LePa", "AsRo", "RaSc", "TaSc", "JeSe", "AnVa", "MarMen", "JonLeh"];
            const EXCLUDE_TEACHERS_SET = new Set(EXCLUDE_TEACHER_LIST);
            // ---------------------

            // --- Get DOM Elements ---
            const statusNow = document.getElementById('status-now');
            const teachersNowList = document.getElementById('teachers-now');
            const statusCustom = document.getElementById('status-custom');
            const teachersCustomList = document.getElementById('teachers-custom');
            const checkButton = document.getElementById('check-button');
            const dateInput = document.getElementById('date-input');
            const timeFromInput = document.getElementById('time-from-input');
            const timeToInput = document.getElementById('time-to-input');
            const staffSelect = document.getElementById('staff-select');
            const dateEntryInput = document.getElementById('date-entry-input');
            const minutesInput = document.getElementById('minutes-input');
            const saveMinutesButton = document.getElementById('save-minutes-button');
            const saveStatus = document.getElementById('save-status');
            const yearDisplay = document.getElementById('year-display');
            const monthButtonsContainer = document.getElementById('month-buttons');
            const totalsDisplay = document.getElementById('totals-display');
            const exportSummaryButton = document.getElementById('export-summary-button');
            const exportBackupButton = document.getElementById('export-backup-button');
            const clearDataButton = document.getElementById('clear-data-button');
            const importCsvButton = document.getElementById('import-csv-button');
            const csvFileInput = document.getElementById('csv-file-input');
            const importStatus = document.getElementById('import-status');

            // Absence section elements
            const absenceStaffSelect = document.getElementById('absence-staff-select');
            const absenceDateInput = document.getElementById('absence-date-input');
            const absenceTimeFromInput = document.getElementById('absence-time-from-input');
            const absenceTimeToInput = document.getElementById('absence-time-to-input');
            const saveAbsenceButton = document.getElementById('save-absence-button');
            const absenceSaveStatus = document.getElementById('absence-save-status');
            const existingAbsencesList = document.getElementById('existing-absences-list');
            // New Absence Import/Export Elements
            const exportAbsencesButton = document.getElementById('export-absences-button');
            const importAbsencesButton = document.getElementById('import-absences-button');
            const absenceCsvFileInput = document.getElementById('absence-csv-file-input');
            const absenceImportStatus = document.getElementById('absence-import-status');

             // Log if critical elements are missing BEFORE loadData runs
             if (!statusNow || !monthButtonsContainer || !staffSelect || !absenceStaffSelect || !exportAbsencesButton || !importAbsencesButton || !absenceCsvFileInput || !absenceImportStatus) { // Added checks for new elements
                 console.error("Critical DOM element missing! Cannot proceed.", { 
                     statusNowExists: !!statusNow, 
                     monthButtonsContainerExists: !!monthButtonsContainer, 
                     staffSelectExists: !!staffSelect,
                     absenceStaffSelectExists: !!absenceStaffSelect,
                     exportAbsencesButtonExists: !!exportAbsencesButton, // Added logs
                     importAbsencesButtonExists: !!importAbsencesButton,
                     absenceCsvFileInputExists: !!absenceCsvFileInput,
                     absenceImportStatusExists: !!absenceImportStatus
                 });
                 if (statusNow) { statusNow.textContent = "Error: Page structure broken."; statusNow.classList.add('error'); }
                 return; // Stop script execution
             }
             console.log("All critical DOM elements found.");


            // --- Helper Functions ---
            function getIsoWeekAndYear(d) {
                const defaultWeek = { week: 0, year: 0, weekKey: '0000-W00'};
                try {
                    if (!(d instanceof Date) || isNaN(d.getTime())) { console.error("getIsoWeekAndYear received invalid date:", d); return defaultWeek; }
                    const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
                    const dayOfWeek = date.getUTCDay();
                    date.setUTCDate(date.getUTCDate() + 4 - (dayOfWeek || 7));
                    const year = date.getUTCFullYear();
                    const yearStart = new Date(Date.UTC(year, 0, 1));
                    const weekNo = Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
                    if (isNaN(weekNo) || isNaN(year)) { console.error("getIsoWeekAndYear calculation resulted in NaN:", {date: d, weekNo, year}); return defaultWeek; }
                    return { week: weekNo, year: year, weekKey: `${year}-W${String(weekNo).padStart(2, '0')}` };
                } catch (error) { console.error("Critical error inside getIsoWeekAndYear:", error, "Input date:", d); return defaultWeek; }
            }
            function timeToMinutes(timeStr) {
                if (!timeStr) return 0; timeStr = timeStr.replace(':', ''); if (timeStr.length < 4) timeStr = '0' + timeStr; const hours = parseInt(timeStr.substring(0, 2), 10); const minutes = parseInt(timeStr.substring(2, 4), 10); return (isNaN(hours) || isNaN(minutes)) ? 0 : (hours * 60) + minutes;
            }
            function minutesToHHMM(totalMinutes) {
                if (isNaN(totalMinutes)) return "00:00"; const hours = Math.floor(totalMinutes / 60); const minutes = totalMinutes % 60; return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
            }
            function parseRealWeeks(weekString) {
                const weeks = new Set(); if (!weekString) return weeks; weekString.split(',').forEach(range => { const parts = range.trim().split('-'); if (parts.length === 1 && parts[0]) { const weekNum = parseInt(parts[0], 10); if (!isNaN(weekNum)) weeks.add(weekNum); } else if (parts.length === 2 && parts[0] && parts[1]) { try { const start = parseInt(parts[0], 10); const end = parseInt(parts[1], 10); if (!isNaN(start) && !isNaN(end)) { for (let i = start; i <= end; i++) { weeks.add(i); } } } catch(e){ console.error("Error parsing week range:", range, e); } } }); return weeks;
            }
            function parseTeachers(teacherString) {
                try {
                    // Handle names potentially quoted in CSV
                    if (teacherString && teacherString.startsWith('"') && teacherString.endsWith('"')) {
                        teacherString = teacherString.substring(1, teacherString.length - 1).replace(/""/g, '"');
                    }
                    if (!teacherString || typeof teacherString !== 'string') return [];
                    const teachers = teacherString.split(',').map(t => t.trim()).filter(t => t && t.length > 0);
                    return Array.isArray(teachers) ? teachers : [];
                } catch (error) { console.error("Error inside parseTeachers:", error, "Input:", teacherString); return []; }
            }
             // Function to safely parse CSV lines, handling quoted fields with commas
            function parseCsvLine(line) {
                const result = [];
                let currentField = '';
                let inQuotes = false;
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        if (inQuotes && line[i + 1] === '"') {
                            // Escaped quote
                            currentField += '"';
                            i++; // Skip the next quote
                        } else {
                            inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        result.push(currentField.trim());
                        currentField = '';
                    } else {
                        currentField += char;
                    }
                }
                result.push(currentField.trim()); // Add the last field
                return result;
            }

            // --- Logic Function 1: Availability at a specific moment ---
             function getAvailabilityAtTime(dateTime) {
                 const defaultResult = { available: [], onCallTimes: new Map() };
                 try {
                     if (!Array.isArray(lessons) || lessons.length === 0) { console.log("getAvailabilityAtTime: No lessons data."); return defaultResult; }
                     const workingTeachers = new Set(); const onCallTimesMap = new Map(); const busyTeachers = new Set();
                     const weekInfo = getIsoWeekAndYear(dateTime); if (!weekInfo) { console.error("getIsoWeekAndYear failed in getAvailabilityAtTime"); return defaultResult; } const { week: checkWeekNum, year: checkWeekYear } = weekInfo;
                     const checkDay = dayMap[dateTime.getDay()]; const checkTimeInMinutes = (dateTime.getHours() * 60) + dateTime.getMinutes();
                     lessons.forEach(lesson => {
                         try { const lessonDay = lesson[columnMap['day']]?.trim(); const weekString = lesson[columnMap['realweeks']]; const subject = lesson[columnMap['subject']]?.trim().toLowerCase(); const startStr = lesson[columnMap['starttime']]; const lenStr = lesson[columnMap['length']]; const teacherStr = lesson[columnMap['teacher']]; if (!lessonDay || !weekString || !subject || !startStr || !lenStr) return; const lessonWeeks = parseRealWeeks(weekString); if (lessonDay !== checkDay || !lessonWeeks.has(checkWeekNum)) return; const lessonStart = timeToMinutes(startStr); const lessonLength = parseInt(lenStr, 10); if (isNaN(lessonLength) || lessonLength <= 0) return; const lessonEnd = lessonStart + lessonLength; if (checkTimeInMinutes >= lessonStart && checkTimeInMinutes < lessonEnd) { const teachers = parseTeachers(teacherStr); if (subject === ARBETSTID_SUBJECT) { teachers.forEach(t => workingTeachers.add(t)); } else if (subject === ON_CALL_SUBJECT) { teachers.forEach(t => { workingTeachers.add(t); if (!onCallTimesMap.has(t)) { onCallTimesMap.set(t, { start: lessonStart, end: lessonEnd }); } }); } else { teachers.forEach(t => busyTeachers.add(t)); } } } catch (e) { console.error("Error processing lesson row (getAvailabilityAtTime):", lesson, e); }
                     });
                     
                     // CHANGE 3C: Integrate absence check
                     let availableAndNotBusy = [...workingTeachers].filter(teacher => !busyTeachers.has(teacher));
                     let availableTeacherNames = availableAndNotBusy.filter(teacher => !isTeacherAbsent(teacher, dateTime, checkTimeInMinutes));

                     return { available: availableTeacherNames.sort(), onCallTimes: onCallTimesMap };
                 } catch (error) { console.error("Critical Error in getAvailabilityAtTime:", error); statusNow.textContent = `Error calculating availability: ${error.message}`; statusNow.classList.add('error'); return defaultResult; }
             }

            // --- Logic Function 2: Availability for a time range ---
             function getAvailabilityForRange(checkDate, checkStartMinutes, checkEndMinutes) {
                 const defaultResult = { available: [], onCallTimes: new Map() };
                 try {
                     if (!Array.isArray(lessons) || lessons.length === 0) { console.log("getAvailabilityForRange: No lessons."); return defaultResult; }
                     let workingTeachers = new Set(); const onCallTimesMap = new Map(); const busyTeachers = new Set();
                     const weekInfo = getIsoWeekAndYear(checkDate); if (!weekInfo) { console.error("getIsoWeekAndYear failed in getAvailabilityForRange"); return defaultResult; } const { week: checkWeekNum, year: checkWeekYear } = weekInfo;
                     const checkDay = dayMap[checkDate.getDay()];
                     lessons.forEach(lesson => {
                         try { const lessonDay = lesson[columnMap['day']]?.trim(); const weekString = lesson[columnMap['realweeks']]; const subject = lesson[columnMap['subject']]?.trim().toLowerCase(); const startStr = lesson[columnMap['starttime']]; const lenStr = lesson[columnMap['length']]; const teacherStr = lesson[columnMap['teacher']]; if (!lessonDay || !weekString || !subject || !startStr || !lenStr) return; const lessonWeeks = parseRealWeeks(weekString); if (lessonDay !== checkDay || !lessonWeeks.has(checkWeekNum)) return; const lessonStart = timeToMinutes(startStr); const lessonLength = parseInt(lenStr, 10); if (isNaN(lessonLength) || lessonLength <= 0) return; const lessonEnd = lessonStart + lessonLength; const teachers = parseTeachers(teacherStr); const containsQuery = (lessonStart <= checkStartMinutes && lessonEnd >= checkEndMinutes); const overlapsQuery = (lessonStart < checkEndMinutes && lessonEnd > checkStartMinutes); if (subject === ARBETSTID_SUBJECT) { if (containsQuery) teachers.forEach(t => workingTeachers.add(t)); } else if (subject === ON_CALL_SUBJECT) { if (containsQuery) { teachers.forEach(t => { workingTeachers.add(t); if (!onCallTimesMap.has(t)) { onCallTimesMap.set(t, { start: lessonStart, end: lessonEnd }); } }); } } else if (overlapsQuery) { teachers.forEach(t => busyTeachers.add(t)); } } catch (e) { console.error("Error processing lesson row (getAvailabilityForRange):", lesson, e); }

