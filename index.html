<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Teacher Availability</title>
    <style>
        :root {
            --bg: #102d69; --container: #1a3a7f; --text: #dbdad8; --input-bg: #2a4a8f; --border: #9a9b9d;
            --button: #00a0df; --button-hover: #007ead; --success: #2ea44f; --danger: #d73a49; --warn: #ffc107;
            --pink: #ffc0cb; --pink-border: #ff69b4;
        }
        [data-theme="light"] {
            --bg: #f8f9fa; --container: #ffffff; --text: #212529; --input-bg: #f1f3f5; --border: #ced4da;
            --button: #007ead; --button-hover: #005c8a; --success: #28a745; --danger: #dc3545; --warn: #ffc107;
            --pink: #ff69b4; --pink-border: #ff1493;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; background-color: var(--bg); color: var(--text); max-width: 800px; margin: 20px auto; padding: 20px; transition: all 0.3s ease; }
        #theme-toggle { position: fixed; top: 15px; right: 15px; z-index: 1001; background: var(--button); color: white; border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 24px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        #theme-toggle:hover { background: var(--button-hover); transform: scale(1.1); }
        #sync-status { position: fixed; top: 70px; right: 15px; z-index: 1000; background: var(--success); color: white; padding: 8px 16px; border-radius: 30px; font-size: 0.9em; font-weight: bold; box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: all 0.3s; }
        #sync-status.offline { background: var(--warn); }
        #sync-status.error { background: var(--danger); }
        #reminder-banner { display: none; position: sticky; top: 70px; z-index: 99; background-color: #fff3cd; color: #856404; padding: 15px 20px; margin-bottom: 20px; border: 1px solid #ffeaa7; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); text-align: center; }
        [data-theme="light"] #reminder-banner { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }
        .logo { width: 180px; height: auto; margin-bottom: 10px; }
        h1 { border-bottom: 2px solid #00a0df; padding-bottom: 10px; color: var(--text); }
        h2 { background-color: #0366d6; color: #ffffff; margin: -24px -24px 20px -24px; padding: 12px 24px; border-radius: 6px 6px 0 0; }
        [data-theme="light"] h2 { background-color: #007ead; }
        .container { background-color: var(--container); border: 1px solid var(--border); border-radius: 6px; padding: 24px; margin-bottom: 20px; color: var(--text); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .key-legend { list-style: none; padding: 0; margin: 10px 0 0 0; display: flex; flex-wrap: wrap; gap: 15px; font-size: 0.9em; }
        .key-legend li { in: flex; align-items: center; }
        .key-dot { width: 12px; height: 12px; border-radius: 50%; margin-right: 6px; border: 1px solid rgba(0,0,0,0.2); }
        .key-dot.green { background-color: var(--success); }
        .key-dot.red { background-color: var(--danger); }
        .key-dot.yellow { background-color: var(--warn); }
        .key-dot.pink { background-color: var(--pink); }
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-weight: 600; margin-bottom: 5px; color: var(--text); }
        .input-group input, .input-group select { width: 95%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; background-color: var(--input-bg); color: var(--text); }
        button { background-color: var(--button); color: #ffffff; font-weight: 600; padding: 10px 16px; border: 1px solid var(--button-hover); border-radius: 6px; cursor: pointer; margin-top: 10px; transition: all 0.2s ease; }
        button:hover { background-color: var(--button-hover); }
        button.btn-green { background-color: var(--success); }
        button.secondary { background-color: var(--border); color: var(--text); }
        button.danger { background-color: var(--danger); }
        button.primary { background-color: #6f42c1; }
        .teacher-list { display: flex; flex-wrap: wrap; gap: 8px; list-style: none; padding: 0; }
        .teacher-list li { background-color: var(--input-bg); border: 1px solid var(--border); border-radius: 10px; padding: 5px 12px; color: var(--text); font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace; }
        .teacher-list li.on-call { background-color: var(--success); color: white; border-color: #218838; font-weight: 600; }
        .teacher-list li.minutes-danger { background-color: var(--danger); color: white; border: 1px solid #c82333; font-weight: 600; }
        .teacher-list li.minutes-warn { background-color: var(--warn); border: 1px solid #e0a800; color: #212529; }
        .teacher-list li.break-duty { background-color: var(--pink); color: #000; border: 2px solid var(--pink-border); font-weight: 600; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 105, 180, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(255, 105, 180, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 105, 180, 0); } }
        #oncall-now-banner { margin: 15px 0; padding: 10px; background-color: rgba(46, 164, 79, 0.15); border: 1px solid var(--success); border-radius: 6px; font-weight: 600; color: var(--success); text-align: center; display: none; }
        .month-buttons button.active { background-color: var(--button); color: white; font-weight: 600; }
        .status { margin-top: 8px; }
        .status.error { color: var(--danger); font-weight: 600; }
        .status.success { color: var(--success); font-weight: 600; }
        #csv-file-input { display: none; }
        .button-group { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
        .delete-absence-btn { margin-left: 10px; font-size: 0.8em; padding: 2px 6px; }
    </style>
</head>
<body>
    <button id="theme-toggle">Moon</button>
    <div id="sync-status">Initializing...</div>
    <div id="reminder-banner">
        <p>Don't forget to save your data!</p>
        <button id="reminder-save-minutes" class="btn-green">Save Minutes</button>
        <button id="reminder-save-absences" class="btn-green">Save Absences</button>
        <button id="reminder-dismiss" class="secondary">Dismiss</button>
    </div>
    <img src="logo.png" alt="Logo" class="logo">
    <h1>Teacher Availability</h1>
  
    <ul class="key-legend">
        <li><span class="key-dot green"></span>On Call</li>
        <li><span class="key-dot red"></span>Monthly Limit (≥180 min)</li>
        <li><span class="key-dot yellow"></span>Weekly Limit (≥90 min)</li>
        <li><span class="key-dot pink"></span>Break Duty</li>
    </ul>

    <!-- YOUR FULL ORIGINAL HTML FROM HERE -->
    <div class="container">
        <h2>Who is Available Now?</h2>
        <div id="status-now" class="status">Loading schedule...</div>
        <div id="results-now" class="results">
            <div id="oncall-now-banner">
                Currently On Call: <span id="oncall-names"></span>
            </div>
            <ul id="teachers-now" class="teacher-list"></ul>
        </div>
    </div>
    <!-- ... all your other containers ... -->
    <!-- (keep everything exactly as before) -->

    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // === ALL YOUR ORIGINAL JS VARIABLES & FUNCTIONS ===
            // (Paste your entire working script here — everything from let lessons = [] to loadData();)

            // === REAL-TIME GOOGLE SHEETS SYNC v3 ===
            const CLIENT_ID = '73139023023-hm3s2vrtmg6utkirhal3c4gdgqspm3ga.apps.googleusercontent.com';
            const SPREADSHEET_ID = '1KFUc1Wjp16Q1K7hoyJ_a064qMpqg6l92iDU7E5dDsxs';
            const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';

            let tokenClient;
            let gapiInited = false;
            let gisInited = false;
            let isOnline = navigator.onLine;
            let lastSync = 0;

            const syncStatus = document.getElementById('sync-status');

            function updateSyncStatus(msg, type = '') {
                syncStatus.textContent = msg;
                syncStatus.className = type;
            }

            window.addEventListener('online', () => { isOnline = true; updateSyncStatus('Online', ''); loadFromSheets(); });
            window.addEventListener('offline', () => { isOnline = false; updateSyncStatus('Offline', 'offline'); });

            function gapiLoaded() {
                gapi.load('client', async () => {
                    await gapi.client.init({
                        discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
                    });
                    gapiInited = true;
                    maybeBoot();
                });
            }

            function gisLoaded() {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: (resp) => {
                        if (resp.error) { updateSyncStatus('Auth failed', 'error'); return; }
                        updateSyncStatus('Connected');
                        loadFromSheets();
                        startAutoSync();
                    },
                });
                gisInited = true;
                maybeBoot();
            }

            function maybeBoot() {
                if (gapiInited && gisInited) {
                    const token = gapi.client.getToken();
                    if (token) {
                        updateSyncStatus('Connected');
                        loadFromSheets();
                        startAutoSync();
                    } else {
                        updateSyncStatus('Tap to connect');
                        const btn = document.createElement('button');
                        btn.textContent = 'Connect Google Sheets';
                        btn.style.cssText = 'position:fixed;top:110px;right:15px;z-index:1000;padding:10px 16px;font-weight:600;';
                        btn.onclick = () => tokenClient.requestAccessToken();
                        document.body.appendChild(btn);
                    }
                }
            }

            async function loadFromSheets() {
                if (!gapi.client.getToken()) return;
                try {
                    const [minResp, absResp] = await Promise.all([
                        gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: 'Minutes!A:C' }),
                        gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: 'Absences!A:E' })
                    ]);

                    const localMinutes = getSavedMinutesData();
                    (minResp.result.values || []).slice(1).forEach(r => {
                        const [date, staff, mins] = r;
                        if (!localMinutes[staff]) localMinutes[staff] = {};
                        localMinutes[staff][date] = (localMinutes[staff][date] || 0) + parseInt(mins || 0);
                    });
                    saveMinutesData(localMinutes);

                    const localAbs = getSavedAbsences();
                    (absResp.result.values || []).slice(1).forEach(r => {
                        const [date, staff, start, end, reason] = r;
                        if (!localAbs[date]) localAbs[date] = {};
                        if (!localAbs[date][staff]) localAbs[date][staff] = [];
                        localAbs[date][staff].push({start: timeToMinutes(start), end: timeToMinutes(end), reason});
                    });
                    saveAbsences(localAbs);

                    updateSyncStatus('Synced just now');
                    refreshAllViews();
                    lastSync = Date.now();
                } catch (err) {
                    updateSyncStatus('Sync error', 'error');
                    console.error(err);
                }
            }

            async function saveToSheets() {
                if (!isOnline || !gapi.client.getToken()) return;
                try {
                    await gapi.client.sheets.spreadsheets.batchUpdate({
                        spreadsheetId: SPREADSHEET_ID,
                        resource: { requests: [
                            { updateCells: { range: { sheetId: 0, startRowIndex: 0 }, fields: "*" } }, // clear Minutes
                            { updateCells: { range: { sheetId: 1, startRowIndex: 0 }, fields: "*" } }  // clear Absences
                        ]}
                    });

                    const minRows = [["Date","Staff","Minutes"], ...Object.entries(getSavedMinutesData()).flatMap(([s,d]) => Object.entries(d).map(([date,m]) => [date,s,m]))];
                    const absRows = [["Date","Staff","Start","End","Reason"], ...Object.entries(getSavedAbsences()).flatMap(([d,ss]) => Object.entries(ss).flatMap(([s,es]) => es.map(e => [d,s,minutesToHHMM(e.start),minutesToHHMM(e.end),e.reason||'']))) ];

                    await Promise.all([
                        gapi.client.sheets.spreadsheets.values.append({ spreadsheetId: SPREADSHEET_ID, range: 'Minutes!A1', valueInputOption: 'RAW', resource: {values: minRows} }),
                        gapi.client.sheets.spreadsheets.values.append({ spreadsheetId: SPREADSHEET_ID, range: 'Absences!A1', valueInputOption: 'RAW', resource: {values: absRows} })
                    ]);

                    updateSyncStatus('Saved to cloud');
                    lastSync = Date.now();
                } catch (err) {
                    updateSyncStatus('Save failed', 'error');
                }
            }

            function startAutoSync() {
                clearInterval(window.syncInterval);
                window.syncInterval = setInterval(() => {
                    if (Date.now() - lastSync > 30000) {
                        loadFromSheets();
                        if (isOnline) saveToSheets();
                    }
                }, 30000);
            }

            function refreshAllViews() {
                const now = new Date();
                const avail = getAvailabilityAtTime(now);
                displayResults(avail.available, avail.onCallTimes, avail.dutyTeachers, teachersNowList, statusNow, now);
                if (activeMonthButton) activeMonthButton.click();
                displayAbsencesForDate(viewAbsenceDateInput.value || now.toISOString().split('T')[0]);
            }

            // Override saves
            const origSaveMinutes = saveMinutesData;
            saveMinutesData = (d) => { origSaveMinutes(d); if (isOnline) saveToSheets(); };

            const origSaveAbs = saveAbsences;
            saveAbsences = (d) => { origSaveAbs(d); if (isOnline) saveToSheets(); };

            // === YOUR ORIGINAL loadData() AND EVERYTHING ELSE BELOW ===
            // (keep exactly as in your last working version)

            loadData();
        });
    </script>
</body>
</html>
